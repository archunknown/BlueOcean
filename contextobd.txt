/** * CONTEXTO DE BASE DE DATOS - PROYECTO BLUE OCEAN
 * Motor: PostgreSQL (Supabase)
 */

-- 1. ESTRUCTURA DE TABLAS (SCHEMA)
-- Tabla principal de servicios
CREATE TABLE public.tours (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  slug text NOT NULL UNIQUE,
  title text NOT NULL,
  category text NOT NULL, -- Valores: 'Tour' | 'Alquiler'
  short_description text,
  long_description text,
  price text,             -- Ej: 'S/ 40'
  image_url text,         -- URL del bucket 'tours-images'
  duration text,
  schedule text,
  group_size text,        -- OJO: En el código se mapea a veces como 'capacity', pero la columna real es 'group_size'
  itinerary jsonb,        -- Estructura: { title: string, items: string[] }
  details jsonb,          -- Estructura: { title: string, items: string[] }
  created_at timestamptz DEFAULT now()
);

-- Tabla de galería multimedia
CREATE TABLE public.gallery (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  title text NOT NULL,
  category text NOT NULL, -- 'Islas', 'Desierto', 'Reserva', 'Aventura'
  image_url text NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- 2. SEGURIDAD Y PERMISOS (RLS)
ALTER TABLE public.tours ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.gallery ENABLE ROW LEVEL SECURITY;

-- Políticas de LECTURA (Públicas para todos)
CREATE POLICY "Lectura pública Tours" ON public.tours FOR SELECT TO anon USING (true);
CREATE POLICY "Lectura pública Galería" ON public.gallery FOR SELECT TO anon USING (true);

-- Políticas de ESCRITURA (Solo Admins/Autenticados)
CREATE POLICY "Admin total access tours" ON public.tours FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Admin total access gallery" ON public.gallery FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- 3. STORAGE (Almacenamiento)
-- Bucket público: 'tours-images' (Carpetas: /tours, /gallery)
-- Bucket privado: 'receipts'
-- Políticas de Storage para Admin:
-- INSERT, UPDATE, DELETE permitidos en 'tours-images' para rol 'authenticated'.

-- 4. DATOS DE EJEMPLO (SNAPSHOT)
-- Tours actuales
INSERT INTO public.tours (slug, title, category, price, group_size) VALUES
('islas-ballestas', 'Islas Ballestas', 'Tour', 'S/ 40', '40-50 pax'),
('reserva-nacional-auto', 'Reserva Nacional en Auto', 'Tour', 'S/ 90', 'Privado'),
('mini-buggies-arenacross', 'Mini Buggies Arenacross', 'Tour', 'S/ 100', '1-2 personas'),
('alquiler-moto-scooter', 'Alquiler de Moto Scooter', 'Alquiler', 'S/ 80', '1-2 personas'),
('alquiler-bicicleta', 'Alquiler de Bicicleta', 'Alquiler', 'S/ 25', 'Individual');